name: üöÄ –î–µ–ø–ª–æ–π Homework Bot (–ü—Ä—è–º–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
      
    - name: üîß Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: üì¶ Install dependencies
      run: npm ci
      
    - name: üî® Build
      run: npm run build
      
    - name: üì¶ Create deployment archive
      run: |
        tar -czf homework-bot.tar.gz \
          -C . \
          dist/ \
          package*.json \
          ecosystem.config.js \
          docker-compose.direct.yml \
          Dockerfile \
          DEPLOY_OPTIONS.md \
          deploy.sh
      
    - name: üñ•Ô∏è Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          mkdir -p /opt/homework-bot
          cd /opt/homework-bot
          
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∞—Ä—Ö–∏–≤–æ–≤
          mkdir -p /tmp/homework-bot-deploy
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
          cd /tmp/homework-bot-deploy
          
          # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤
          tar -czf homework-bot-deploy.tar.gz -C /home/runner/work/homework-bot/homework-bot \
            dist/ \
            package*.json \
            ecosystem.config.js \
            docker-compose.direct.yml \
            Dockerfile \
            DEPLOY_OPTIONS.md \
            deploy.sh
          
          # –ö–æ–ø–∏—Ä—É–µ–º –∞—Ä—Ö–∏–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
          cp homework-bot-deploy.tar.gz /opt/homework-bot/
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
          cd /opt/homework-bot
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          docker-compose down || true
          
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–¥
          tar -xzf homework-bot-deploy.tar.gz
          
          # –ö–æ–ø–∏—Ä—É–µ–º docker-compose.yml
          cp docker-compose.direct.yml docker-compose.yml
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          docker-compose build
          docker-compose up -d
          
          # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã
          docker image prune -f
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
          docker-compose ps
          
          # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          rm -f homework-bot-deploy.tar.gz
