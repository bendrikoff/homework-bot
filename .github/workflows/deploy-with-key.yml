name: ğŸ”‘ Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Homework Bot (SSH ĞºĞ»ÑÑ‡)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
       
    - name: ğŸ”¨ Build
      run: npm run build
       
    - name: ğŸ“¦ Create deployment package
      run: |
        tar -czf homework-bot.tar.gz \
          dist/ \
          package*.json \
          ecosystem.config.js \
          DEPLOY_OPTIONS.md \
          deploy.sh \
          env.example
        echo "ğŸ“¦ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ğ°Ñ€Ñ…Ğ¸Ğ²: $(ls -lh homework-bot.tar.gz)"
        
    - name: ğŸ”‘ Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
        
    - name: ğŸ“¤ Upload to server  
      run: |
        scp -o StrictHostKeyChecking=no -r homework-bot.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/homework-bot/
        
    - name: ğŸš€ Deploy  
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
        cd /opt/homework-bot
        
        echo "ğŸ”§ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸..."
        
        # PM2 ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°
        if ! command -v node &> /dev/null; then
          echo "ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Node.js..."
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
        fi
        
        if ! command -v pm2 &> /dev/null; then
          echo "ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ PM2..."
          sudo npm install -g pm2
        fi
        
        echo "ğŸ›‘ ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ±Ğ¾Ñ‚Ğ°..."
        pm2 stop homework-bot || true
        pm2 delete homework-bot || true
        
        echo "ğŸ“¦ Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ ĞºĞ¾Ğ´..."
        if [ -f homework-bot.tar.gz ]; then
          tar -xzf homework-bot.tar.gz
          rm homework-bot.tar.gz
        else
          echo "âŒ ĞÑ€Ñ…Ğ¸Ğ² Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!"
          exit 1
        fi
        
        echo "ğŸ“ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°..."
        if [ ! -f .env ]; then
          cp env.example .env
          echo "âš ï¸ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ .env - Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ñ‚Ğ¾ĞºĞµĞ½Ñ‹!"
        fi
        
        echo "ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº..."
        npm ci --production
        pm2 start ecosystem.config.js --env production  
        pm2 save
        
        echo "âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾!"
        pm2 status
EOF
