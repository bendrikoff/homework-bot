name: 🔑 Деплой Homework Bot (SSH ключ)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout
      uses: actions/checkout@v4
      
    - name: 🔧 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: 📦 Install dependencies
      run: npm ci
       
    - name: 🔨 Build
      run: npm run build
       
    - name: 📦 Create deployment package
      run: |
        tar -czf homework-bot.tar.gz \
          dist/ \
          package*.json \
          ecosystem.config.js \
          DEPLOY_OPTIONS.md \
          deploy.sh \
          env.example
        echo "📦 Создан архив: $(ls -lh homework-bot.tar.gz)"
        
    - name: 🔑 Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
        
    - name: 📤 Upload to server  
      run: |
        scp -o StrictHostKeyChecking=no -r homework-bot.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/homework-bot/
        
    - name: 🚀 Deploy  
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
        cd /opt/homework-bot
        
        echo "🔧 Проверяем зависимости..."
        
        # PM2 установка
        if ! command -v node &> /dev/null; then
          echo "📦 Устанавливаем Node.js..."
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
        fi
        
        if ! command -v pm2 &> /dev/null; then
          echo "📦 Устанавливаем PM2..."
          sudo npm install -g pm2
        fi
        
        echo "🛑 Останавливаем бота..."
        pm2 stop homework-bot || true
        pm2 delete homework-bot || true
        
        echo "📦 Извлекаем код..."
        if [ -f homework-bot.tar.gz ]; then
          tar -xzf homework-bot.tar.gz
          rm homework-bot.tar.gz
        else
          echo "❌ Архив не найден!"
          exit 1
        fi
        
        echo "📁 Настройка..."
        if [ ! -f .env ]; then
          cp env.example .env
          echo "⚠️ Создан .env - заполните токены!"
        fi
        
        echo "🚀 Запуск..."
        npm ci --production
        pm2 start ecosystem.config.js --env production  
        pm2 save
        
        echo "✅ Готово!"
        pm2 status
EOF
