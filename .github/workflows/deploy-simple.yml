name: üöÄ –î–µ–ø–ª–æ–π Homework Bot (–ü—Ä–æ—Å—Ç–æ–π)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
      
    - name: üîß Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: üì¶ Install dependencies
      run: npm ci
      
    - name: üî® Build
      run: npm run build
      
    - name: üì¶ Create deployment archive
      run: |
        tar -czf homework-bot-simple.tar.gz \
          dist/ \
          package*.json \
          ecosystem.config.js \
          DEPLOY_OPTIONS.md \
          deploy.sh \
          env.example
        echo "üì¶ –°–æ–∑–¥–∞–Ω –∞—Ä—Ö–∏–≤ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è: $(ls -lh homework-bot-simple.tar.gz)"
        
    - name: üì§ Upload archive to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        source: "homework-bot-simple.tar.gz"
        target: "/opt/homework-bot/"
        strip_components: 0
       
    - name: üñ•Ô∏è Deploy with PM2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          cd /opt/homework-bot
          
          echo "üîß –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Node.js
          if ! command -v node &> /dev/null; then
            echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js..."
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ PM2
          if ! command -v pm2 &> /dev/null; then
            echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2..."
            sudo npm install -g pm2
          fi
          
          echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å..."
          pm2 stop homework-bot || true
          pm2 delete homework-bot || true
          
          echo "üì¶ –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–¥..."
          if [ -f homework-bot-simple.tar.gz ]; then
            tar -xzf homework-bot-simple.tar.gz
            rm homework-bot-simple.tar.gz
          else
            echo "‚ùå –ê—Ä—Ö–∏–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi
          
          echo "üìÅ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
          if [ ! -f .env ]; then
            cp env.example .env
            echo "‚ö†Ô∏è –°–æ–∑–¥–∞–Ω .env —Ñ–∞–π–ª - –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω—ã!"
          fi
          
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
          npm ci --production
          
          echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å PM2..."
          pm2 start ecosystem.config.js --env production
          
          echo "üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é PM2..."
          pm2 save
          
          echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
          echo "üìä –°—Ç–∞—Ç—É—Å PM2:"
          pm2 status
          echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
          pm2 logs homework-bot --lines 5
