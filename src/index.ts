import { Telegraf, Context } from 'telegraf';
import * as dotenv from 'dotenv';
import { LatexRenderer } from './latexRenderer';
import { OpenRouterService } from './openRouterService';
import * as fs from 'fs';
import * as path from 'path';

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
dotenv.config();

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞
if (!process.env.BOT_TOKEN) {
  console.error('‚ùå BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!');
  console.log('–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ç—É–¥–∞ BOT_TOKEN=your_bot_token_here');
  process.exit(1);
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API –∫–ª—é—á–∞ OpenRouter
if (!process.env.OPENROUTER_API_KEY) {
  console.error('‚ùå OPENROUTER_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!');
  console.log('–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ç—É–¥–∞ OPENROUTER_API_KEY=your_api_key_here');
  process.exit(1);
}

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
const bot = new Telegraf(process.env.BOT_TOKEN);

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Ä–µ–Ω–¥–µ—Ä–µ—Ä–∞ LaTeX
const latexRenderer = new LatexRenderer();

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞ OpenRouter
const openRouterService = new OpenRouterService(
  process.env.OPENROUTER_API_KEY!,
  process.env.OPENROUTER_MODEL || 'meta-llama/llama-3.1-8b-instruct:free'
);

// –ü–∞–ø–∫–∞ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø—Ä—è–º—É—é –≤ AI

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
bot.start((ctx: Context) => {
  const welcomeMessage = `
ü§ñ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Homework Bot —Å AI!

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
/start - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
/help - –ü–æ–º–æ—â—å
/ping - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –±–æ—Ç–∞
/about - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ
/latex - –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å LaTeX —Ñ–æ—Ä–º—É–ª—É –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

ü§ñ AI —Ñ—É–Ω–∫—Ü–∏–∏:
‚Ä¢ –û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å, –∏ —è –æ—Ç–≤–µ—á—É —Å –ø–æ–º–æ—â—å—é AI
‚Ä¢ AI —Ä–µ—à–∞–µ—Ç —É—Ä–∞–≤–Ω–µ–Ω–∏—è, –æ–±—ä—è—Å–Ω—è–µ—Ç –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏, –ø–æ–º–æ–≥–∞–µ—Ç —Å –∑–∞–¥–∞—á–∞–º–∏
‚Ä¢ **–û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏** –∑–∞–¥–∞—á, —É—Ä–∞–≤–Ω–µ–Ω–∏–π, –¥–∏–∞–≥—Ä–∞–º–º - AI –∏—Ö –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç!
‚Ä¢ –û—Ç–≤–µ—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π LaTeX —Ñ–æ—Ä–º—É–ª
‚Ä¢ –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π

üìê LaTeX —Ñ—É–Ω–∫—Ü–∏–∏:
‚Ä¢ –û—Ç–ø—Ä–∞–≤—å—Ç–µ LaTeX —Ñ–æ—Ä–º—É–ª—É, –∏ —è –ø—Ä–µ–æ–±—Ä–∞–∑—É—é –µ—ë –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: –¥—Ä–æ–±–∏, –∫–æ—Ä–Ω–∏, –∏–Ω—Ç–µ–≥—Ä–∞–ª—ã, —Å—É–º–º—ã, –≥—Ä–µ—á–µ—Å–∫–∏–µ –±—É–∫–≤—ã –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ
‚Ä¢ –ü—Ä–∏–º–µ—Ä—ã: $\\frac{a}{b}$, $\\sqrt{x^2 + y^2}$, $\\sum_{i=1}^{n} i$

–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏ —è –æ—Ç–≤–µ—á—É —Å –ø–æ–º–æ—â—å—é AI! üòä
  `;
  
  ctx.reply(welcomeMessage);
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
bot.help((ctx: Context) => {
  const helpMessage = `
üìö –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º:

/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º
/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É
/ping - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
/about - –£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –æ –±–æ—Ç–µ
/latex - –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å LaTeX —Ñ–æ—Ä–º—É–ª—É –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

ü§ñ AI —Ñ—É–Ω–∫—Ü–∏–∏:
‚Ä¢ –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å - –ø–æ–ª—É—á–∏—Ç–µ –æ—Ç–≤–µ—Ç –æ—Ç AI
‚Ä¢ AI —Ä–µ—à–∞–µ—Ç —É—Ä–∞–≤–Ω–µ–Ω–∏—è, –∑–∞–¥–∞—á–∏, –æ–±—ä—è—Å–Ω—è–µ—Ç –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏
‚Ä¢ **–û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏** –∑–∞–¥–∞—á, —É—Ä–∞–≤–Ω–µ–Ω–∏–π, –¥–∏–∞–≥—Ä–∞–º–º - AI –∏—Ö –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç!
‚Ä¢ –û—Ç–≤–µ—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å LaTeX –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
‚Ä¢ –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏, —Ñ–∏–∑–∏–∫–∏, –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è

üìê LaTeX —Ñ–æ—Ä–º—É–ª—ã:
‚Ä¢ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ä–º—É–ª—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ: $—Ñ–æ—Ä–º—É–ª–∞$
‚Ä¢ –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /latex —Ñ–æ—Ä–º—É–ª–∞
‚Ä¢ –ü—Ä–∏–º–µ—Ä—ã:
  - $\\frac{a}{b}$ - –¥—Ä–æ–±—å
  - $\\sqrt{x^2 + y^2}$ - –∫–æ—Ä–µ–Ω—å
  - $\\sum_{i=1}^{n} i$ - —Å—É–º–º–∞
  - $\\int_0^\\infty e^{-x} dx$ - –∏–Ω—Ç–µ–≥—Ä–∞–ª
  - $\\alpha + \\beta = \\gamma$ - –≥—Ä–µ—á–µ—Å–∫–∏–µ –±—É–∫–≤—ã

üí° –°–æ–≤–µ—Ç: –û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å, –∏ —è –æ—Ç–≤–µ—á—É —Å –ø–æ–º–æ—â—å—é AI!
  `;
  
  ctx.reply(helpMessage);
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /ping
bot.command('ping', (ctx: Context) => {
  ctx.reply('üèì Pong! –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ!');
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /about
bot.command('about', (ctx: Context) => {
  const aboutMessage = `
ü§ñ Homework Bot v2.1.0 —Å AI –∏ Vision

–°–æ–∑–¥–∞–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º:
‚Ä¢ TypeScript
‚Ä¢ Telegraf.js
‚Ä¢ Node.js
‚Ä¢ OpenRouter API (–¥–ª—è AI –æ—Ç–≤–µ—Ç–æ–≤ –∏ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
‚Ä¢ KaTeX (–¥–ª—è LaTeX —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞)
‚Ä¢ Marked (–¥–ª—è Markdown —Ä–∞–∑–º–µ—Ç–∫–∏)

–≠—Ç–æ—Ç –±–æ—Ç –ø–æ–º–æ–∂–µ—Ç –≤–∞–º —Å –¥–æ–º–∞—à–Ω–∏–º–∏ –∑–∞–¥–∞–Ω–∏—è–º–∏, –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã —Å –ø–æ–º–æ—â—å—é AI, –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∑–∞–¥–∞—á –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç LaTeX —Ñ–æ—Ä–º—É–ª—ã –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è!
  `;
  
  ctx.reply(aboutMessage);
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /latex
bot.command('latex', async (ctx: Context) => {
  const messageText = (ctx.message as any)?.text || '';
  const latexFormula = messageText.replace('/latex', '').trim();
  
  if (!latexFormula) {
    ctx.reply('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ LaTeX —Ñ–æ—Ä–º—É–ª—É –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã /latex\n\n–ü—Ä–∏–º–µ—Ä: /latex \\frac{a}{b}');
    return;
  }
  
  try {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ
    const processingMessage = await ctx.reply('üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é LaTeX —Ñ–æ—Ä–º—É–ª—É...');
    
    // –†–µ–Ω–¥–µ—Ä–∏–º LaTeX –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    const imagePath = await latexRenderer.renderLatexToPng(latexFormula);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    await ctx.replyWithPhoto(
      { source: imagePath },
      {
        caption: `üìê LaTeX —Ñ–æ—Ä–º—É–ª–∞:\n\`${latexFormula}\``,
        parse_mode: 'Markdown'
      }
    );
    
    // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ
    await ctx.deleteMessage(processingMessage.message_id);
    
    // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    latexRenderer.cleanup(imagePath);
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ LaTeX:', error);
    const errorMessage = error instanceof Error ? error.message : String(error);
    ctx.reply(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ LaTeX —Ñ–æ—Ä–º—É–ª—ã:\n\`${errorMessage}\``, {
      parse_mode: 'Markdown'
    });
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('text', async (ctx: Context) => {
  const userMessage = (ctx.message as any)?.text || '';
  
  // –í—Å–µ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ AI –∏ –ø–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
  try {
    const processingMessage = await ctx.reply('ü§ñ AI –¥—É–º–∞–µ—Ç...');
    
    // –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è AI
    const systemPrompt = `–¢—ã –ø–æ–ª–µ–∑–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø–æ–º–æ—â–∏ —Å –¥–æ–º–∞—à–Ω–∏–º–∏ –∑–∞–¥–∞–Ω–∏—è–º–∏. 
–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –∏—Å–ø–æ–ª—å–∑—É—è Markdown —Ä–∞–∑–º–µ—Ç–∫—É –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤.

–ü—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- –ò—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥–æ–ª–æ–≤–∫–∏ (# ## ###) –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–π **–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç** –¥–ª—è –≤–∞–∂–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–π *–∫—É—Ä—Å–∏–≤* –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑—É–π —Å–ø–∏—Å–∫–∏ (- –∏–ª–∏ 1.) –¥–ª—è –ø–æ—à–∞–≥–æ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–π –±–ª–æ–∫–∏ –∫–æ–¥–∞ (\`\`\`—è–∑—ã–∫\`\`\`) –¥–ª—è –ø—Ä–∏–º–µ—Ä–æ–≤ –∫–æ–¥–∞
- –ò—Å–ø–æ–ª—å–∑—É–π > –¥–ª—è —Ü–∏—Ç–∞—Ç –∏ –≤–∞–∂–Ω—ã—Ö –∑–∞–º–µ—á–∞–Ω–∏–π

–î–ª—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–æ—Ä–º—É–ª –∏—Å–ø–æ–ª—å–∑—É–π LaTeX —Å–∏–Ω—Ç–∞–∫—Å–∏—Å:
- $—Ñ–æ—Ä–º—É–ª–∞$ –¥–ª—è –∏–Ω–ª–∞–π–Ω —Ñ–æ—Ä–º—É–ª
- $$—Ñ–æ—Ä–º—É–ª–∞$$ –¥–ª—è –±–ª–æ—á–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª

–ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º. –û–±—ä—è—Å–Ω—è–π —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º.
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç —Ä–µ—à–∏—Ç—å —É—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏–ª–∏ –∑–∞–¥–∞—á—É, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∂–∏ –ø–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å —Ñ–æ—Ä–º—É–ª–∞–º–∏.`;

    // –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç AI
    const aiResponse = await openRouterService.sendUserMessage(userMessage, systemPrompt);
    
    // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ
    await ctx.deleteMessage(processingMessage.message_id);
    
    // –†–µ–Ω–¥–µ—Ä–∏–º –æ—Ç–≤–µ—Ç AI –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Markdown + LaTeX
    const imagePath = await latexRenderer.renderMarkdownWithLatexToPng(aiResponse, {
      fontSize: 18,
      maxWidth: 1000,
      textAlign: 'left',
      lineHeight: 1.4,
    });

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –æ—Ç–≤–µ—Ç–æ–º
    await ctx.replyWithPhoto({ source: imagePath }, {
      caption: 'ü§ñ –û—Ç–≤–µ—Ç –æ—Ç AI',
    });

    // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    latexRenderer.cleanup(imagePath);
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å AI:', error);
    const errorMessage = error instanceof Error ? error.message : String(error);
    
    // –ï—Å–ª–∏ AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—ã—á–Ω—ã–π –æ—Ç–≤–µ—Ç
    const fallbackResponses = [
      '–ò–∑–≤–∏–Ω–∏—Ç–µ, AI –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.',
      '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ AI. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.',
      'AI —Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'
    ];
    
    const randomResponse = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
    await ctx.reply(`${randomResponse}\n\nüí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å LaTeX —Ñ–æ—Ä–º—É–ª—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: $\\frac{a}{b}$) –∏–ª–∏ –∫–æ–º–∞–Ω–¥—É /help –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.`);
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
bot.on('photo', async (ctx: Context) => {
  try {
    const processingMessage = await ctx.reply('üñºÔ∏è –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...');
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–æ—Ç–æ
    const photo = (ctx.message as any)?.photo;
    if (!photo || photo.length === 0) {
      await ctx.reply('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
      return;
    }
    
    // –ë–µ—Ä–µ–º —Ñ–æ—Ç–æ –Ω–∞–∏–±–æ–ª—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
    const largestPhoto = photo[photo.length - 1];
    const fileId = largestPhoto.file_id;
    
    // –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª –æ—Ç Telegram
    const fileLink = await ctx.telegram.getFileLink(fileId);
    const response = await fetch(fileLink);
    const imageBuffer = await response.arrayBuffer();
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ base64 –Ω–∞–ø—Ä—è–º—É—é
    const base64Image = Buffer.from(imageBuffer).toString('base64');
    
    // –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    const systemPrompt = `–¢—ã –ø–æ–ª–µ–∑–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø–æ–º–æ—â–∏ —Å –¥–æ–º–∞—à–Ω–∏–º–∏ –∑–∞–¥–∞–Ω–∏—è–º–∏. 
–¢—ã —É–º–µ–µ—à—å –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏, —É—Ä–∞–≤–Ω–µ–Ω–∏—è–º–∏, –¥–∏–∞–≥—Ä–∞–º–º–∞–º–∏, –≥—Ä–∞—Ñ–∏–∫–∞–º–∏.

–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –∏—Å–ø–æ–ª—å–∑—É—è Markdown —Ä–∞–∑–º–µ—Ç–∫—É –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤.

–ü—Ä–∞–≤–∏–ª–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:
- –ï—Å–ª–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞ - —Ä–µ—à–∞–π –µ—ë –ø–æ—à–∞–≥–æ–≤–æ
- –ï—Å–ª–∏ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ - –ø–æ–∫–∞–∂–∏ –ø–æ–ª–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å —Ñ–æ—Ä–º—É–ª–∞–º–∏
- –ï—Å–ª–∏ –≥—Ä–∞—Ñ–∏–∫ –∏–ª–∏ –¥–∏–∞–≥—Ä–∞–º–º–∞ - –æ–±—ä—è—Å–Ω–∏ —á—Ç–æ –Ω–∞ –Ω–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–æ
- –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç - –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –µ–≥–æ –∏ –¥–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç
- –ò—Å–ø–æ–ª—å–∑—É–π LaTeX —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–æ—Ä–º—É–ª: $—Ñ–æ—Ä–º—É–ª–∞$ –∏ $$—Ñ–æ—Ä–º—É–ª–∞$$
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏, —Å–ø–∏—Å–∫–∞–º–∏, –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º –≤–∞–∂–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤

–ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º. –û–±—ä—è—Å–Ω—è–π —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º.`;

    // –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç AI —Å –∞–Ω–∞–ª–∏–∑–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é
    const aiResponse = await openRouterService.sendMessageWithImageBuffer(
      '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –ø–æ–º–æ–≥–∏ —Å –∑–∞–¥–∞—á–µ–π',
      base64Image,
      'image/jpeg',
      systemPrompt
    );
    
    // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ—Ü–µ—Å—Å–µ
    await ctx.deleteMessage(processingMessage.message_id);
    
    // –†–µ–Ω–¥–µ—Ä–∏–º –æ—Ç–≤–µ—Ç AI –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Markdown + LaTeX
    const responseImagePath = await latexRenderer.renderMarkdownWithLatexToPng(aiResponse, {
      fontSize: 18,
      maxWidth: 1000,
      textAlign: 'left',
      lineHeight: 1.4,
    });

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –æ—Ç–≤–µ—Ç–æ–º
    await ctx.replyWithPhoto({ source: responseImagePath }, {
      caption: 'ü§ñ –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç AI',
    });

    // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –æ—Ç–≤–µ—Ç–∞
    latexRenderer.cleanup(responseImagePath);
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
    const errorMessage = error instanceof Error ? error.message : String(error);
    
    // –ï—Å–ª–∏ AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—ã—á–Ω—ã–π –æ—Ç–≤–µ—Ç
    const fallbackResponses = [
      '–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.',
      '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.',
      'AI —Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'
    ];
    
    const randomResponse = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
    await ctx.reply(`${randomResponse}\n\nüí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –∫–æ–º–∞–Ω–¥—É /help –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.`);
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
bot.catch((err: any, ctx: Context) => {
  console.error('–û—à–∏–±–∫–∞ –≤ –±–æ—Ç–µ:', err);
  ctx.reply('üòî –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
});

// –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
console.log('üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...');

bot.launch()
  .then(() => {
    console.log('‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!');
    console.log('üì± –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ –≤ Telegram');
  })
  .catch((error) => {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞:', error);
    process.exit(1);
  });

// Graceful stop
process.once('SIGINT', () => {
  console.log('üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª SIGINT, –∑–∞–≤–µ—Ä—à–∞—é —Ä–∞–±–æ—Ç—É...');
  latexRenderer.cleanupAll();
  bot.stop('SIGINT');
});

process.once('SIGTERM', () => {
  console.log('üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª SIGTERM, –∑–∞–≤–µ—Ä—à–∞—é —Ä–∞–±–æ—Ç—É...');
  latexRenderer.cleanupAll();
  bot.stop('SIGTERM');
});
